@page
@model GiacenzaSorterRm.Pages.PagesAggiornamento.PagesMacero.IndexModel

@{
    ViewData["Title"] = "Macero";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

@section styles {
    <link rel="stylesheet" href="~/css/pages/macero.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/forms.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/spinners.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/components/modals.css" asp-append-version="true" />
}

    <div class="container-fluid">

        <div class="card text-white bg-info mb-1 max-w-100">

            <div class="card-body">
                <h2 class="text-center">Macero</h2>
            </div>

        </div>


        <br />

        <form class="d-flex flex-wrap gap-2 justify-content-center" method="post" id="formReport">



            <div class="mb-3">
            <select asp-for="IdCommessa" class=" m-2 mr-2 col-xs-9 form-control" asp-items="@Model.CommesseSL" id="selectCommessa">
                    <option value="0">- Seleziona Commessa -</option>
                </select>
                <span asp-validation-for="IdCommessa" class="text-danger"></span>
            </div>


            <label for="StartDate" class="m-1 col-xs-3 col-form-label ml-4 mr-2">Dal :</label>
            <div class="m-2 col-xs-9">
                <input asp-for="StartDate" class="form-control mr-4" />
                <span asp-validation-for="StartDate" class="text-danger"></span>
            </div>


            <label for="EndDate" class="m-1 col-xs-3 col-form-label mr-2">Al :</label>
            <div class="m-2 col-xs-9">
                <input asp-for="EndDate" class="form-control" />
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>

            <div class="m-2 col-auto px-0">
                <button type="submit" class="col-auto btn btn-primary" id="btnStartNorm">Report</button>
            </div>

        </form>

        <br /><br />

        <div id="divProcessing" class="d-none" role="status" aria-live="polite" aria-busy="true">
            <br />
            <br />
            <p class="text-center" aria-hidden="true">Processing data, please wait . . .</p>
            <p class="sr-only">Caricamento in corso...</p>
            <p>
                <img class="mx-auto d-block" src="~/images/Spinner.gif" alt="Caricamento in corso..." role="presentation" />
            </p>

        </div>


        <div class="center-text" id="dvReport"></div>


    </div>

<!-- Modal rischiesta macero-->
<div class="modal fade" 
     id="confirm-submit" 
     tabindex="-1" 
     role="dialog" 
     aria-labelledby="modalMaceroTitle" 
     aria-modal="true"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMaceroTitle">Macera Scatole</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Chiudi">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Macerare la commessa selezionata ?
            </div>
            <div class="modal-footer">
                <button type="button" id="submitModal" class="btn btn-primary">Macera</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
            </div>
        </div>
    </div>
</div>




@section scripts{
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script type="module">
        import { FetchHelpers } from '/js/fetch-helpers.js';

        // Nascondi spinner inizialmente
        FetchHelpers.hideSpinner('divProcessing');

        // Handler click modale macero - modificato per gestire il risultato
        $('#submitModal').click(async function () {
            const modal = $('#confirm-submit');
            const modalBody = modal.find('.modal-body');
            const modalFooter = modal.find('.modal-footer');
            const submitBtn = $('#submitModal');
            const cancelBtn = modal.find('.btn-secondary');
            
            // Disabilita pulsanti durante elaborazione
            submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm mr-2"></span>Elaborazione...');
            cancelBtn.prop('disabled', true);
            
            // Mostra spinner nella pagina principale
            FetchHelpers.showSpinner('divProcessing');
            document.getElementById('dvReport').style.display = 'none';
            
            try {
                // Ottieni i dati dal form nascosto nel partial
                const formData = new FormData(document.getElementById('formRiepilogo'));
                
                // Esegui la chiamata al server
                const response = await fetch('?handler=Macera', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    
                    // Aggiorna il contenuto della pagina
                    document.getElementById('dvReport').innerHTML = html;
                    document.getElementById('dvReport').style.display = 'block';
                    
                    // Estrai il messaggio di successo dal partial usando l'attributo data-success
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const alertDiv = tempDiv.querySelector('#maceroResultMessage');
                    let message = 'Operazione completata';
                    let isSuccess = false;
                    let isWarning = false;
                    
                    if (alertDiv) {
                        message = alertDiv.textContent.trim();
                        isSuccess = alertDiv.getAttribute('data-success') === 'true';
                        isWarning = alertDiv.classList.contains('alert-warning');
                    }
                    
                    console.log('Macero result:', { message, isSuccess, isWarning });
                    
                    // Aggiorna la modale con il risultato
                    if (isSuccess) {
                        modalBody.html(`
                            <div class="text-center">
                                <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">${message}</h4>
                            </div>
                        `);
                        modalFooter.html(`
                            <button type="button" class="btn btn-success" data-bs-dismiss="modal">Chiudi</button>
                        `);
                    } else if (isWarning) {
                        modalBody.html(`
                            <div class="text-center">
                                <i class="fas fa-info-circle text-warning" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">${message}</h4>
                            </div>
                        `);
                        modalFooter.html(`
                            <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Chiudi</button>
                        `);
                    } else {
                        modalBody.html(`
                            <div class="text-center">
                                <i class="fas fa-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">${message}</h4>
                            </div>
                        `);
                        modalFooter.html(`
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Chiudi</button>
                        `);
                    }
                    
                } else {
                    throw new Error('Errore nella risposta del server');
                }
                
            } catch (error) {
                console.error('Errore durante il macero:', error);
                modalBody.html(`
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Errore durante l'operazione</h4>
                        <p>${error.message}</p>
                    </div>
                `);
                modalFooter.html(`
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Chiudi</button>
                `);
                document.getElementById('dvReport').style.display = 'block';
            } finally {
                FetchHelpers.hideSpinner('divProcessing');
            }
        });

        // Handler submit form per report
        document.getElementById('formReport').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectCommessa = document.querySelector('#selectCommessa');
            
            // Validazione commessa selezionata
            if (selectCommessa.value == 0) {
                alert('Seleziona una commessa');
                return;
            }
            
            const form = e.target;
            const formData = new FormData(form);
            
            console.log('Form data:', {
                IdCommessa: formData.get('IdCommessa'),
                StartDate: formData.get('StartDate'),
                EndDate: formData.get('EndDate')
            });
            
            FetchHelpers.showSpinner('divProcessing');
            document.getElementById('dvReport').style.display = 'none';
            
            try {
                const html = await FetchHelpers.postFormWithUpdate(
                    '?handler=Report',
                    formData,
                    'dvReport',
                    (responseHtml) => {
                        console.log('Response received:', responseHtml.substring(0, 100));
                        FetchHelpers.hideSpinner('divProcessing');
                        document.getElementById('dvReport').style.display = 'block';
                        
                        // Debug: Verifica disponibilità librerie
                        console.log('DataTables disponibile:', typeof $.fn.DataTable);
                        console.log('Buttons disponibile:', typeof $.fn.DataTable.Buttons);
                        
                        if (document.getElementById('tableProduzione')) {
                            console.log('✅ Tabella #tableProduzione trovata');
                            
                            // Distruggi DataTable esistente se presente
                            if ($.fn.DataTable.isDataTable('#tableProduzione')) {
                                console.log('Distruggo DataTable esistente');
                                $('#tableProduzione').DataTable().destroy();
                            }
                            
                            // ✅ SOLUZIONE: Configura tutti i bottoni PRIMA dell'inizializzazione
                            const buttonsConfig = [
                                {
                                    extend: 'excelHtml5',
                                    autoFilter: true,
                                    text: '<i class="fas fa-file-excel"></i> Export to Excel',
                                    exportOptions: {
                                        columns: ':not(.notexport)',
                                        format: {
                                            body: function (data, row, column, node) {
                                                data = $('<p>' + data + '</p>').text();
                                                return column === 2 ?
                                                    data.replace(/[.]/g, '') :
                                                    data;
                                            }
                                        }
                                    },
                                    className: 'btn btn-primary',
                                    title: function () {
                                        return 'Riepilogo scatole dal ' + $('#StartDate').val() + ' al ' + $('#EndDate').val();
                                    }
                                }
                            ];
                            
                            @if (Model.Ruolo == "ADMIN" || Model.Ruolo == "SUPERVISOR")
                            {
                                <text>
                                // ✅ Aggiungi bottone Macera condizionalmente
                                console.log('✅ Utente ADMIN/SUPERVISOR - Aggiungo bottone Macera');
                                buttonsConfig.push({
                                    text: '<i class="far fa-trash-alt"></i> Macera',
                                    className: 'btn btn-danger ml-2',
                                    action: function (e, dt, button, config) {
                                        console.log('Click su bottone Macera');
                                        $('#confirm-submit').modal('show');
                                    }
                                });
                                </text>
                            }
                            
                            console.log('Configurazione bottoni:', buttonsConfig);
                            
                            // ✅ Inizializza DataTable con array di bottoni completo
                            try {
                                const table = $('#tableProduzione').DataTable({
                                    dom: 'Bfrtip',
                                    buttons: buttonsConfig,
                                    columnDefs: [
                                        {
                                            targets: 0,
                                            orderable: false,
                                            searchable: false,
                                        }
                                    ],
                                    order: [[1, 'asc']],
                                    scrollX: true
                                });
                                
                                console.log('✅ DataTable inizializzato con successo');
                                console.log('Numero bottoni:', table.buttons().count());
                                
                            } catch (dtError) {
                                console.error('❌ Errore inizializzazione DataTable:', dtError);
                            }
                            
                        } else {
                            console.warn('❌ Tabella #tableProduzione NON trovata nel DOM');
                        }
                    },
                    (error) => {
                        console.error('Error callback triggered:', error);
                        FetchHelpers.hideSpinner('divProcessing');
                        document.getElementById('dvReport').style.display = 'block';
                        alert('Errore durante il caricamento del report. Riprova.');
                    }
                );
            } catch (error) {
                console.error('Errore report:', error);
                FetchHelpers.hideSpinner('divProcessing');
                document.getElementById('dvReport').style.display = 'block';
            }
        });
    </script>
}

